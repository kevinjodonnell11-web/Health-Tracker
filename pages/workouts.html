<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workouts - Health Tracker</title>
    <link rel="stylesheet" href="../css/styles.css?v=10">
    <link rel="stylesheet" href="../css/dashboard.css?v=10">
    <link rel="stylesheet" href="../css/auth.css?v=10">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        .workout-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .workout-entry {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .workout-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .workout-day-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
        }

        .workout-info h3 {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .workout-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .workout-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .exercises-table {
            width: 100%;
            margin-top: 1rem;
        }

        .exercises-table th {
            text-align: left;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .exercises-table td {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .exercise-name-cell {
            font-weight: 500;
        }

        .sets-display {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .set-chip {
            background-color: var(--bg-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .cardio-info {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: var(--bg-primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .cardio-icon {
            color: var(--color-success);
        }

        .workout-notes {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: var(--bg-primary);
            border-radius: var(--radius-sm);
            font-style: italic;
            color: var(--text-secondary);
        }

        .workout-actions {
            display: flex;
            gap: 0.5rem;
        }

        .workout-actions .btn-sm {
            padding: 0.4rem 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .workout-actions .btn-sm svg {
            width: 16px;
            height: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-primary);
        }

        .stat-card .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .filter-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .view-mode-toggle {
            display: inline-flex;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.2rem;
            gap: 0.2rem;
        }

        .view-mode-btn {
            border: none;
            background: transparent;
            color: var(--text-secondary);
            padding: 0.45rem 0.7rem;
            border-radius: calc(var(--radius-sm) - 2px);
            font-weight: 600;
            font-size: 0.82rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .view-mode-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.03);
        }

        .view-mode-btn.active {
            background: var(--color-primary);
            color: white;
        }

        .history-summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .history-month {
            margin-bottom: 1.25rem;
        }

        .history-month-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.75rem;
            padding: 0.25rem 0.1rem;
        }

        .history-month-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.01em;
        }

        .history-month-count {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .stat-card-btn {
            cursor: pointer;
            transition: var(--transition);
        }

        .stat-card-btn:hover {
            border-color: var(--color-primary);
            transform: translateY(-1px);
        }

        .stat-card-btn:focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        .exercise-block {
            background-color: var(--bg-primary);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .exercise-header {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .exercise-header .form-select {
            flex: 1;
        }

        .sets-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .set-row {
            display: grid;
            grid-template-columns: 30px 1fr 1fr auto auto;
            gap: 0.5rem;
            align-items: center;
        }

        .set-row .copy-set-btn,
        .set-row .remove-set-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            min-width: 32px;
        }

        .set-row .remove-set-btn {
            background: transparent;
            border-color: var(--color-danger);
            color: var(--color-danger);
        }

        .set-row .remove-set-btn:hover {
            background: var(--color-danger);
            color: white;
        }

        .set-number {
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            margin-bottom: 1rem;
        }

        .workout-entry {
            cursor: pointer;
            transition: var(--transition);
        }

        .workout-entry:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
        }

        #searchFilter {
            flex: 1;
            min-width: 150px;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        /* Mobile optimizations for workouts page */
        @media (max-width: 768px) {
            .page-header {
                margin-bottom: 1rem;
            }

            .page-title {
                font-size: 1.35rem;
            }

            /* Stats grid - 2x2 on mobile */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                margin-bottom: 1.25rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-card .stat-value {
                font-size: 1.5rem;
            }

            .stat-card .stat-label {
                font-size: 0.75rem;
            }

            /* Filter bar stacking */
            .filter-bar {
                flex-direction: column;
                gap: 0.75rem;
            }

            .view-mode-toggle {
                width: 100%;
                justify-content: center;
            }

            .view-mode-btn {
                flex: 1;
                text-align: center;
            }

            #searchFilter {
                width: 100%;
            }

            /* Workout entries - compact */
            .workout-entry {
                padding: 1rem;
            }

            .workout-entry:hover {
                transform: none;
            }

            .workout-entry:active {
                background: var(--bg-card-hover);
            }

            .workout-header {
                margin-bottom: 0.75rem;
            }

            .workout-title {
                gap: 0.75rem;
            }

            .workout-day-number {
                font-size: 1.25rem;
            }

            .workout-info h3 {
                font-size: 1rem;
            }

            /* Exercise table - more compact */
            .exercises-table th,
            .exercises-table td {
                padding: 0.4rem 0.25rem;
                font-size: 0.8rem;
            }

            .set-chip {
                font-size: 0.7rem;
                padding: 0.15rem 0.35rem;
            }

            /* Workout actions - bigger touch targets */
            .workout-actions .btn-sm {
                min-width: 40px;
                min-height: 40px;
                padding: 0.5rem;
            }

            .workout-actions .btn-sm svg {
                width: 18px;
                height: 18px;
            }

            /* Workout meta info */
            .workout-meta {
                font-size: 0.8rem;
                gap: 0.75rem;
            }

            /* New Workout button on mobile */
            #newWorkoutBtn {
                padding: 0.5rem 0.875rem;
                font-size: 0.85rem;
            }

            .history-summary {
                align-items: flex-start;
                flex-direction: column;
                gap: 0.25rem;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-left">
            <h1>HEALTH TRACKER</h1>
        </div>
        <nav class="main-nav">
            <a href="../index.html" class="nav-link">Dashboard</a>
            <a href="workouts.html" class="nav-link active">Workouts</a>
            <a href="nutrition.html" class="nav-link">Nutrition</a>
            <a href="analytics.html" class="nav-link">Analytics</a>
        </nav>
        <div class="header-right">
            <button id="newWorkoutBtn" class="btn btn-primary">+ New Workout</button>
            <a href="settings.html" class="settings-btn" title="Settings">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </a>
        </div>
    </header>

    <main class="page-container">
        <div class="page-header">
            <h2 class="page-title">Workout Log</h2>
        </div>

        <div class="stats-grid" id="workoutStats">
            <!-- Stats will be populated by JS -->
        </div>

        <div class="filter-bar">
            <div class="view-mode-toggle" id="viewModeToggle" aria-label="Workout history mode">
                <button type="button" class="view-mode-btn active" data-mode="all">All Workouts</button>
                <button type="button" class="view-mode-btn" data-mode="recent">Last 30 Days</button>
            </div>
            <select class="form-select" id="typeFilter" style="width: 150px;">
                <option value="">All Types</option>
                <option value="push">Push</option>
                <option value="pull">Pull</option>
                <option value="legs">Legs</option>
                <option value="upper">Upper</option>
                <option value="cardio">Cardio</option>
                <option value="superset">Superset</option>
            </select>
            <select class="form-select" id="sortFilter" style="width: 170px;">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
            </select>
            <input type="text" class="form-input" id="searchFilter" placeholder="Search exercises..." style="width: 200px;">
        </div>

        <div class="history-summary">
            <span id="historyCount">0 workouts</span>
            <span id="historyHint">Tip: tap any workout card to open the full day view.</span>
        </div>

        <div class="workout-list" id="workoutList">
            <!-- Workouts will be populated by JS -->
        </div>
    </main>

    <!-- Workout Modal -->
    <div class="modal" id="workoutModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="workoutModalTitle">Log Workout</h2>
                <button class="modal-close" id="workoutModalClose">&times;</button>
            </div>
            <div class="modal-body" id="workoutModalBody">
                <!-- Form will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-items">
            <a href="../index.html" class="mobile-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span>Home</span>
            </a>
            <a href="workouts.html" class="mobile-nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6.5 6.5h11v11h-11z"></path>
                    <path d="M6.5 1v5.5M17.5 1v5.5M6.5 17.5V23M17.5 17.5V23M1 6.5h5.5M1 17.5h5.5M17.5 6.5H23M17.5 17.5H23"></path>
                </svg>
                <span>Workouts</span>
            </a>
            <a href="nutrition.html" class="mobile-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
                    <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
                </svg>
                <span>Nutrition</span>
            </a>
            <a href="analytics.html" class="mobile-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                <span>Analytics</span>
            </a>
            <a href="settings.html" class="mobile-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                <span>Settings</span>
            </a>
        </div>
    </nav>

    <!-- Pull to Refresh Indicator -->
    <div class="pull-to-refresh" id="pullToRefresh">
        <div class="pull-spinner"></div>
        <span>Pull down to refresh</span>
    </div>

    <script src="../js/firebase-config.js?v=10"></script>
    <script src="../js/storage.js?v=10"></script>
    <script src="../js/auth.js?v=10"></script>
    <script src="../js/cloud-storage.js?v=10"></script>
    <script src="../js/metrics.js?v=10"></script>
    <script src="../js/workouts.js?v=10"></script>
    <script src="../js/dayview.js?v=10"></script>
    <script src="../js/pwa-utils.js?v=10"></script>
    <script>
        // State
        let viewMode = 'all'; // all | recent
        const RECENT_WINDOW_DAYS = 30;

        function safeText(value) {
            return window.escapeHtml ? window.escapeHtml(value ?? '') : String(value ?? '');
        }

        function safeWorkoutType(type) {
            return Workouts.WORKOUT_TYPES.includes(type) ? type : 'push';
        }

        function safeViewMode(mode) {
            return mode === 'recent' ? 'recent' : 'all';
        }

        function refreshWorkoutPage() {
            renderStats();
            renderWorkoutList();
        }

        function applyQueryState() {
            const params = new URLSearchParams(window.location.search);
            const queryView = params.get('view');
            const queryType = params.get('type');
            const querySort = params.get('sort');
            const querySearch = params.get('search');

            if (queryView) {
                viewMode = safeViewMode(queryView);
            }
            if (queryType && Workouts.WORKOUT_TYPES.includes(queryType)) {
                document.getElementById('typeFilter').value = queryType;
            }
            if (querySort === 'oldest' || querySort === 'newest') {
                document.getElementById('sortFilter').value = querySort;
            }
            if (querySearch) {
                document.getElementById('searchFilter').value = querySearch.slice(0, 80);
            }
            syncViewModeButtons();
        }

        function syncViewModeButtons() {
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === viewMode);
            });
            const hint = document.getElementById('historyHint');
            if (hint) {
                hint.textContent = viewMode === 'all'
                    ? 'Tip: tap any workout card to open the full day view.'
                    : `Showing the last ${RECENT_WINDOW_DAYS} days. Switch to All Workouts for full history.`;
            }
        }

        function setViewMode(nextMode) {
            viewMode = safeViewMode(nextMode);
            syncViewModeButtons();
            renderWorkoutList();
        }

        // Page initialization
        document.addEventListener('DOMContentLoaded', () => {
            // Fix any incorrect workout day numbers
            if (typeof Workouts !== 'undefined' && Workouts.recalculateDayNumbers) {
                Workouts.recalculateDayNumbers();
            }

            applyQueryState();
            refreshWorkoutPage();
            setupEventListeners();
        });

        function setupEventListeners() {
            // New workout button
            document.getElementById('newWorkoutBtn').addEventListener('click', () => openWorkoutModal());

            // Modal close
            document.getElementById('workoutModalClose').addEventListener('click', closeModal);
            document.getElementById('workoutModal').addEventListener('click', (e) => {
                if (e.target.id === 'workoutModal') closeModal();
            });

            // View mode toggle
            document.getElementById('viewModeToggle').addEventListener('click', (e) => {
                const modeBtn = e.target.closest('.view-mode-btn');
                if (!modeBtn) return;
                setViewMode(modeBtn.dataset.mode);
            });

            // Filters
            document.getElementById('typeFilter').addEventListener('change', () => {
                renderWorkoutList();
            });
            document.getElementById('sortFilter').addEventListener('change', renderWorkoutList);

            // Search with debounce
            let searchTimeout;
            document.getElementById('searchFilter').addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    renderWorkoutList();
                }, 300);
            });

            // Drill into stat cards
            document.getElementById('workoutStats').addEventListener('click', (e) => {
                const statCard = e.target.closest('[data-stat-action]');
                if (!statCard) return;

                const action = statCard.dataset.statAction;
                if (action === 'all') {
                    setViewMode('all');
                } else if (action === 'recent') {
                    setViewMode('recent');
                } else if (action === 'analytics') {
                    window.location.href = 'analytics.html?focus=workout-frequency';
                }
            });
            document.getElementById('workoutStats').addEventListener('keydown', (e) => {
                if (e.key !== 'Enter' && e.key !== ' ') return;
                const statCard = e.target.closest('[data-stat-action]');
                if (!statCard) return;
                e.preventDefault();
                statCard.click();
            });

            // Open day detail by tapping workout card
            document.getElementById('workoutList').addEventListener('click', (e) => {
                if (e.target.closest('button, .btn, a, input, select, textarea')) {
                    return;
                }
                const entry = e.target.closest('.workout-entry[data-workout-date]');
                if (!entry) return;
                if (window.DayView) {
                    DayView.open(entry.dataset.workoutDate);
                }
            });
        }

        function renderStats() {
            const stats = Workouts.getLifetimeStats();
            const recentStats = Workouts.getStats();
            const streak = Workouts.getStreakInfo();

            document.getElementById('workoutStats').innerHTML = `
                <div class="stat-card stat-card-btn" data-stat-action="all" role="button" tabindex="0" title="Show complete workout history">
                    <div class="stat-value">${stats.totalWorkouts}</div>
                    <div class="stat-label">Total Workouts</div>
                </div>
                <div class="stat-card stat-card-btn" data-stat-action="recent" role="button" tabindex="0" title="Show recent workouts">
                    <div class="stat-value">${recentStats.last30Days}</div>
                    <div class="stat-label">Last 30 Days</div>
                </div>
                <div class="stat-card stat-card-btn" data-stat-action="analytics" role="button" tabindex="0" title="Open workout analytics">
                    <div class="stat-value">${stats.totalVolumeFormatted}</div>
                    <div class="stat-label">Lbs Lifted (All Time)</div>
                </div>
                <div class="stat-card stat-card-btn" data-stat-action="recent" role="button" tabindex="0" title="Show recent workouts">
                    <div class="stat-value">${streak.streak}</div>
                    <div class="stat-label">Current Streak</div>
                </div>
            `;
        }

        function workoutMatchesSearch(workout, searchFilter) {
            if (!searchFilter) return true;
            const exerciseText = (workout.exercises || [])
                .map(ex => ex?.name || '')
                .join(' ');
            const searchable = [
                workout.type,
                workout.notes,
                workout.cardio?.type,
                exerciseText,
                workout.date
            ]
                .filter(Boolean)
                .join(' ')
                .toLowerCase();
            return searchable.includes(searchFilter);
        }

        function formatMonthLabel(monthKey) {
            const [yearStr, monthStr] = monthKey.split('-');
            const year = Number(yearStr);
            const month = Number(monthStr);
            if (!Number.isFinite(year) || !Number.isFinite(month)) {
                return 'Unknown Month';
            }
            const date = new Date(year, month - 1, 1);
            return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }

        function getFilteredWorkouts() {
            const typeFilter = document.getElementById('typeFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase().trim();

            let workouts = Storage.workouts.getAll();

            if (viewMode === 'recent') {
                const cutoff = new Date();
                cutoff.setHours(0, 0, 0, 0);
                cutoff.setDate(cutoff.getDate() - (RECENT_WINDOW_DAYS - 1));
                workouts = workouts.filter(workout => new Date(`${workout.date}T00:00:00`) >= cutoff);
            }

            if (typeFilter) {
                workouts = workouts.filter(workout => workout.type === typeFilter);
            }

            if (searchFilter) {
                workouts = workouts.filter(workout => workoutMatchesSearch(workout, searchFilter));
            }

            const sortDirection = sortFilter === 'oldest' ? 1 : -1;
            workouts.sort((a, b) => sortDirection * (new Date(a.date) - new Date(b.date)));

            return workouts;
        }

        function groupWorkoutsByMonth(workouts) {
            const groups = new Map();
            workouts.forEach(workout => {
                const monthKey = String(workout.date || '').slice(0, 7);
                if (!groups.has(monthKey)) {
                    groups.set(monthKey, []);
                }
                groups.get(monthKey).push(workout);
            });
            return Array.from(groups.entries()).map(([monthKey, monthWorkouts]) => ({ monthKey, monthWorkouts }));
        }

        function renderWorkoutCard(workout) {
            const type = safeWorkoutType(workout.type);
            const safeWorkoutId = safeText(workout.id);
            const safeDate = safeText(Storage.formatDate(workout.date));

            return `
                <div class="workout-entry" data-workout-date="${safeText(workout.date)}">
                    <div class="workout-header">
                        <div class="workout-title">
                            <span class="workout-day-number">#${workout.dayNumber || '?'}</span>
                            <div class="workout-info">
                                <h3>
                                    <span class="badge badge-${type}">${safeText(type)}</span>
                                </h3>
                                <div class="workout-date">${safeDate}</div>
                            </div>
                        </div>
                        <div class="workout-actions">
                            <button class="btn btn-sm btn-secondary" data-workout-id="${safeWorkoutId}" onclick="event.stopPropagation(); editWorkout(this.dataset.workoutId)" title="Edit">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    ${workout.exercises.length > 0 ? `
                        <table class="exercises-table">
                            <thead>
                                <tr>
                                    <th>Exercise</th>
                                    <th>Sets</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${workout.exercises.map(ex => `
                                    <tr>
                                        <td class="exercise-name-cell">${safeText(ex.name)}</td>
                                        <td>
                                            <div class="sets-display">
                                                ${ex.sets.map((set) => `
                                                    <span class="set-chip">
                                                        ${set.reps}${set.weight ? ` x ${set.weight}` : ''}
                                                    </span>
                                                `).join('')}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}

                    ${workout.cardio ? `
                        <div class="cardio-info">
                            <span class="cardio-icon">üèÉ</span>
                            <span>${safeText(workout.cardio.type)}</span>
                            ${workout.cardio.distance ? `<span>${workout.cardio.distance} mi</span>` : ''}
                            ${workout.cardio.duration ? `<span>${safeText(workout.cardio.duration)}</span>` : ''}
                        </div>
                    ` : ''}

                    ${workout.notes ? `
                        <div class="workout-notes">"${safeText(workout.notes)}"</div>
                    ` : ''}

                    <div class="workout-meta" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">
                        ${workout.preWeight ? `<span>Weight: ${workout.preWeight} lbs</span>` : ''}
                        ${workout.energyLevel ? `<span>Energy: ${workout.energyLevel}/10</span>` : ''}
                    </div>
                </div>
            `;
        }

        function renderWorkoutList() {
            const workouts = getFilteredWorkouts();
            const container = document.getElementById('workoutList');
            const historyCount = document.getElementById('historyCount');
            historyCount.textContent = `${workouts.length} workout${workouts.length !== 1 ? 's' : ''}`;

            if (workouts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No workouts found</h3>
                        <p>${viewMode === 'recent'
                            ? `No workouts in the last ${RECENT_WINDOW_DAYS} days. Switch to All Workouts or log a new session.`
                            : 'Click "+ New Workout" to log your first workout!'}</p>
                    </div>
                `;
                return;
            }

            const grouped = groupWorkoutsByMonth(workouts);
            container.innerHTML = grouped.map(group => `
                <section class="history-month">
                    <div class="history-month-header">
                        <h3 class="history-month-title">${safeText(formatMonthLabel(group.monthKey))}</h3>
                        <span class="history-month-count">${group.monthWorkouts.length} workout${group.monthWorkouts.length !== 1 ? 's' : ''}</span>
                    </div>
                    <div class="workout-list">
                        ${group.monthWorkouts.map(renderWorkoutCard).join('')}
                    </div>
                </section>
            `).join('');
        }

        let currentEditWorkout = null;

        function openWorkoutModal(workout = null) {
            const modal = document.getElementById('workoutModal');
            const modalBody = document.getElementById('workoutModalBody');
            const modalTitle = document.getElementById('workoutModalTitle');

            currentEditWorkout = workout;
            exerciseCount = 0;

            modalTitle.textContent = workout ? 'Edit Workout' : 'Log Workout';
            modalBody.innerHTML = Workouts.renderWorkoutForm(workout);
            modal.classList.add('active');

            if (workout && workout.exercises && workout.exercises.length > 0) {
                // Add existing exercises for editing
                workout.exercises.forEach((ex, i) => {
                    addExercise(ex.name, ex.sets);
                });
            } else {
                // Add first empty exercise
                addExercise();
            }

            // Setup form events
            setupFormEvents(!!workout);
        }

        function editWorkout(workoutId) {
            const workout = Storage.workouts.findById(workoutId);
            if (workout) {
                openWorkoutModal(workout);
            }
        }

        function closeModal() {
            document.getElementById('workoutModal').classList.remove('active');
            currentEditWorkout = null;
            formEventsSetup = false; // Reset so event listeners get attached on next open
        }

        let exerciseCount = 0;
        let formEventsSetup = false; // Track if listeners are already attached

        function setupFormEvents(isEdit = false) {

            const form = document.getElementById('workoutForm');
            const addExerciseBtn = document.getElementById('addExerciseBtn');
            const workoutTypeSelect = document.getElementById('workoutType');
            const exercisesList = document.getElementById('exercisesList');

            if (!form || !addExerciseBtn || !workoutTypeSelect || !exercisesList) {
                console.error('Form elements not found:', { form, addExerciseBtn, workoutTypeSelect, exercisesList });
                return;
            }

            // Only set up event listeners once
            if (formEventsSetup) {
                // Just handle delete button for this specific edit
                const deleteBtn = document.getElementById('deleteWorkoutBtn');
                if (deleteBtn && currentEditWorkout) {
                    deleteBtn.onclick = () => {
                        if (confirm('Are you sure you want to delete this workout? This cannot be undone.')) {
                            Workouts.deleteWorkout(currentEditWorkout.id);
                            closeModal();
                            refreshWorkoutPage();
                        }
                    };
                }
                return;
            }

            formEventsSetup = true;

            // Add exercise button
            addExerciseBtn.addEventListener('click', () => addExercise());

            // Workout type change - update exercise suggestions
            workoutTypeSelect.addEventListener('change', (e) => {
                // Update exercise dropdowns when type changes
                const workoutType = e.target.value;
                document.querySelectorAll('.exercise-block').forEach(block => {
                    const select = block.querySelector('.exercise-select');
                    const hiddenInput = block.querySelector('.exercise-name');
                    const currentValue = hiddenInput?.value || '';

                    if (select) {
                        const defaultExercises = Workouts.COMMON_EXERCISES[workoutType] || [];
                        const settings = Storage.settings.get();
                        const customExercises = settings.customExercises || [];
                        const allExercises = [...new Set([...defaultExercises, ...customExercises])].sort();
                        const isInList = allExercises.includes(currentValue);

                        select.innerHTML = `
                            <option value="">Select exercise...</option>
                            ${allExercises.map(ex => `<option value="${safeText(ex)}" ${ex === currentValue ? 'selected' : ''}>${safeText(ex)}</option>`).join('')}
                            <option value="__custom__" ${currentValue && !isInList ? 'selected' : ''}>+ Add custom...</option>
                        `;
                    }
                });
            });

            // Delete button (only for edits) - use onclick to allow reassignment
            const deleteBtn = document.getElementById('deleteWorkoutBtn');
            if (deleteBtn && currentEditWorkout) {
                deleteBtn.onclick = () => {
                    if (confirm('Are you sure you want to delete this workout? This cannot be undone.')) {
                        Workouts.deleteWorkout(currentEditWorkout.id);
                        closeModal();
                        refreshWorkoutPage();
                    }
                };
            }

            // Form submission handler
            const handleSubmit = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                const formData = new FormData(form);
                const editId = form.dataset.editId;

                let result;
                try {
                    if (editId) {
                        // Update existing workout
                        result = handleWorkoutUpdate(editId, formData);
                    } else {
                        // Create new workout
                        result = Workouts.handleWorkoutSubmit(formData);
                    }

                    if (result) {
                        closeModal();
                        refreshWorkoutPage();
                        exerciseCount = 0;
                    }
                } catch (error) {
                    console.error('Error submitting workout:', error);
                }
            };

            // Attach to form submit
            form.onsubmit = handleSubmit;

            // Also attach click handler directly to submit button as fallback
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                // Use touchend for mobile, click for desktop
                const handleButtonPress = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    handleSubmit(e);
                };
                submitBtn.addEventListener('click', handleButtonPress);
                // Add touchend listener for mobile Safari
                submitBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    handleButtonPress(e);
                }, { passive: false });
            } else {
                console.error('Submit button not found');
            }

            // Event delegation for exercise select and custom input
            exercisesList.addEventListener('change', (e) => {
                if (e.target.classList.contains('exercise-select')) {
                    const block = e.target.closest('.exercise-block');
                    const customInput = block.querySelector('.exercise-custom');
                    const hiddenInput = block.querySelector('.exercise-name');

                    if (e.target.value === '__custom__') {
                        customInput.style.display = 'block';
                        customInput.focus();
                        hiddenInput.value = '';
                    } else {
                        customInput.style.display = 'none';
                        customInput.value = '';
                        hiddenInput.value = e.target.value;
                    }
                }
                if (e.target.classList.contains('exercise-custom')) {
                    const block = e.target.closest('.exercise-block');
                    const hiddenInput = block.querySelector('.exercise-name');
                    hiddenInput.value = e.target.value;
                }
            });

            exercisesList.addEventListener('input', (e) => {
                if (e.target.classList.contains('exercise-custom')) {
                    const block = e.target.closest('.exercise-block');
                    const hiddenInput = block.querySelector('.exercise-name');
                    hiddenInput.value = e.target.value;
                }
            });

            // Copy set and remove set button handlers
            exercisesList.addEventListener('click', (e) => {
                const copyBtn = e.target.closest('.copy-set-btn');
                if (copyBtn) {
                    const exerciseIndex = copyBtn.dataset.exercise;
                    const setIndex = parseInt(copyBtn.dataset.set);
                    const setsContainer = document.getElementById(`sets_${exerciseIndex}`);
                    const currentRow = setsContainer.querySelector(`[data-set="${setIndex}"]`);
                    const reps = currentRow.querySelector('.set-reps').value;
                    const weight = currentRow.querySelector('.set-weight').value;

                    const nextRow = setsContainer.querySelector(`[data-set="${setIndex + 1}"]`);
                    if (nextRow) {
                        nextRow.querySelector('.set-reps').value = reps;
                        nextRow.querySelector('.set-weight').value = weight;
                    } else {
                        const setCount = setsContainer.querySelectorAll('.set-row').length;
                        setsContainer.insertAdjacentHTML('beforeend', Workouts.renderSetRow(exerciseIndex, setCount, reps, weight));
                    }
                }
                // Remove set button
                const removeSetBtn = e.target.closest('.remove-set-btn');
                if (removeSetBtn) {
                    const setRow = removeSetBtn.closest('.set-row');
                    const setsContainer = setRow.parentElement;
                    // Only remove if more than 1 set remains
                    if (setsContainer.querySelectorAll('.set-row').length > 1) {
                        setRow.remove();
                        // Renumber remaining sets
                        setsContainer.querySelectorAll('.set-row').forEach((row, i) => {
                            row.querySelector('.set-number').textContent = i + 1;
                        });
                    }
                }
            });
        }

        function handleWorkoutUpdate(id, formData) {
            const workout = {
                date: formData.get('date'),
                type: safeWorkoutType(formData.get('type')),
                preWeight: formData.get('preWeight') && Number.isFinite(Number(formData.get('preWeight'))) ? Number(formData.get('preWeight')) : null,
                energyLevel: formData.get('energyLevel') && Number.isFinite(Number(formData.get('energyLevel'))) ? Math.round(Number(formData.get('energyLevel'))) : null,
                notes: formData.get('notes') ? String(formData.get('notes')).trim() : null,
                exercises: [],
                cardio: null
            };


            // Parse exercises (use data-index attribute, not loop index)
            const exerciseBlocks = document.querySelectorAll('.exercise-block');

            exerciseBlocks.forEach((block) => {
                const blockIndex = block.dataset.index;
                let exerciseName = formData.get(`exercise_${blockIndex}_name`);

                // Check if custom input was used but hidden input wasn't updated
                const customInput = block.querySelector('.exercise-custom');
                const selectInput = block.querySelector('.exercise-select');
                if (selectInput && selectInput.value === '__custom__' && customInput && customInput.value) {
                    // Force sync from custom input
                    exerciseName = customInput.value;
                }

                exerciseName = String(exerciseName || '').trim();
                if (!exerciseName) {
                    return;
                }

                const exercise = { name: exerciseName, sets: [] };
                let setIndex = 0;
                while (formData.has(`exercise_${blockIndex}_set_${setIndex}_reps`)) {
                    const reps = formData.get(`exercise_${blockIndex}_set_${setIndex}_reps`);
                    const weight = formData.get(`exercise_${blockIndex}_set_${setIndex}_weight`);
                    if (reps) {
                        const parsedReps = Number(reps);
                        const parsedWeight = weight !== null && weight !== '' ? Number(weight) : null;
                        if (Number.isFinite(parsedReps) && parsedReps > 0) {
                            exercise.sets.push({
                                reps: Math.round(parsedReps),
                                weight: Number.isFinite(parsedWeight) ? parsedWeight : null
                            });
                        }
                    }
                    setIndex++;
                }
                if (exercise.sets.length > 0) {
                    workout.exercises.push(exercise);
                }
            });


            // Parse cardio
            const cardioType = formData.get('cardioType');
            if (cardioType) {
                workout.cardio = {
                    type: String(cardioType).trim(),
                    distance: formData.get('cardioDistance') && Number.isFinite(Number(formData.get('cardioDistance'))) ? Number(formData.get('cardioDistance')) : null,
                    duration: formData.get('cardioDuration') ? String(formData.get('cardioDuration')).trim() : null
                };
            }

            // Save custom exercises
            Workouts.saveCustomExercises(workout.exercises, workout.type);

            const result = Workouts.updateWorkout(id, workout);
            return result;
        }

        function addExercise(exerciseName = '', existingSets = null) {
            const workoutType = document.getElementById('workoutType').value;
            const container = document.getElementById('exercisesList');

            const exerciseHtml = Workouts.renderExerciseBlock(exerciseCount, workoutType, exerciseName, existingSets);
            container.insertAdjacentHTML('beforeend', exerciseHtml);

            // Add event listeners for the new exercise block
            const block = container.querySelector(`[data-index="${exerciseCount}"]`);

            block.querySelector('.remove-exercise').addEventListener('click', (e) => {
                block.remove();
            });

            block.querySelector('.add-set-btn').addEventListener('click', (e) => {
                const exerciseIndex = e.target.dataset.exercise;
                const setsContainer = document.getElementById(`sets_${exerciseIndex}`);
                const setCount = setsContainer.querySelectorAll('.set-row').length;
                const lastSet = setsContainer.querySelector('.set-row:last-child');
                const lastReps = lastSet?.querySelector('.set-reps')?.value || '';
                const lastWeight = lastSet?.querySelector('.set-weight')?.value || '';
                setsContainer.insertAdjacentHTML('beforeend', Workouts.renderSetRow(exerciseIndex, setCount, lastReps, lastWeight));
            });

            exerciseCount++;
        }
    </script>
</body>
</html>
